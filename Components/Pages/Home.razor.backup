@page "/"
@using IcaReceiptTracker.Services
@using IcaReceiptTracker.Models
@inject DataService DataService
@inject IStringLocalizer<IcaReceiptTracker.Resources.SharedResources> Localizer
@rendermode InteractiveServer

<PageTitle>@Localizer["AppTitle"]</PageTitle>

<div class="container">
    <h1>@Localizer["AppTitle"]</h1>

    <div class="tabs">
        <button class="@(activeTab == "add" ? "active" : "")" @onclick='() => activeTab = "add"'>@Localizer["Tab_AddReceipt"]</button>
        <button class="@(activeTab == "view" ? "active" : "")" @onclick='() => activeTab = "view"'>@Localizer["Tab_ViewExpenses"]</button>
        <button class="@(activeTab == "items" ? "active" : "")" @onclick='() => activeTab = "items"'>@Localizer["Tab_ItemsByDate"]</button>
        <button class="@(activeTab == "categories" ? "active" : "")" @onclick='() => activeTab = "categories"'>@Localizer["Tab_Categories"]</button>
    </div>

    @if (activeTab == "add")
    {
        <div class="tab-content">
            <h2>@Localizer["Heading_AddNewReceipt"]</h2>
            
            @if (pendingCategorizationItems.Any())
            {
                <div class="categorization-prompt">
                    <h3>@Localizer["Heading_CategorizeItem"]</h3>
                    <p><strong>@pendingCategorizationItems[0].Name</strong> - @FormatCurrency(pendingCategorizationItems[0].Price)</p>
                    
                    <input @bind="newCategory" placeholder="@Localizer["Label_EnterCategory"]" class="form-input" />
                    
                    @if (DataService.GetAllCategories().Any())
                    {
                        <div class="existing-categories">
                            <p>@Localizer["Label_OrSelectExisting"]</p>
                            @foreach (var cat in DataService.GetAllCategories())
                            {
                                <button class="category-btn" @onclick="() => AssignCategory(cat)">@cat</button>
                            }
                        </div>
                    }
                    
                    <button class="btn btn-primary" @onclick="SaveCategory">@Localizer["Button_SaveCategory"]</button>
                </div>
            }
            else
            {
                <div class="upload-section">
                    <InputFile OnChange="HandleFileUpload" accept=".pdf" />
                    
                    @if (!string.IsNullOrEmpty(uploadMessage))
                    {
                        <p class="@(uploadSuccess ? "success" : "error")">@uploadMessage</p>
                    }
                </div>
            }
        </div>
    }
    else if (activeTab == "view")
    {
        <div class="tab-content">
            <h2>@Localizer["Heading_ViewExpenses"]</h2>
            
            <div class="period-selector">
                <label>@Localizer["Label_SelectPeriod"]</label>
                <input type="month" value="@selectedPeriod" @oninput="OnPeriodChanged" />
            </div>

            @if (showDeleteReceiptsConfirmation)
            {
                <div class="confirmation-overlay">
                    <div class="confirmation-dialog">
                        <h3>@Localizer["Dialog_DeleteReceipts"]</h3>
                        <p>@string.Format(Localizer["Message_DeleteConfirm"], selectedReceiptsForDeletion.Count)</p>
                        <ul class="delete-receipts-list">
                            @foreach (var receipt in selectedReceiptsForDeletion.Take(5))
                            {
                                <li>@receipt.Date.ToString("yyyy-MM-dd") - @receipt.Store - @FormatCurrency(receipt.Total)</li>
                            }
                            @if (selectedReceiptsForDeletion.Count > 5)
                            {
                                <li><em>@string.Format(Localizer["Message_AndMore"], selectedReceiptsForDeletion.Count - 5)</em></li>
                            }
                        </ul>
                        <p class="warning-text">@Localizer["Message_CannotUndo"]</p>
                        <div class="confirmation-actions">
                            <button class="btn-danger-confirm" @onclick="DeleteSelectedReceipts">@Localizer["Button_YesDeleteReceipts"]</button>
                            <button class="btn-cancel-large" @onclick="CancelDeleteReceipts">@Localizer["Button_Cancel"]</button>
                        </div>
                    </div>
                </div>
            }

            @if (currentExpenses != null)
            {
                <div class="expenses-summary">
                    <h3>@string.Format(Localizer["Label_Period"], currentExpenses.StartDate.ToString("yyyy-MM-dd"), currentExpenses.EndDate.ToString("yyyy-MM-dd"))</h3>
                    <h2 class="total">@Localizer["Label_Total"]: @FormatCurrency(currentExpenses.Total)</h2>

                    <h3>@Localizer["Heading_ByCategory"]</h3>
                    <div class="category-breakdown">
                        @foreach (var category in currentExpenses.ByCategory.OrderByDescending(c => c.Value))
                        {
                            var categoryKey = category.Key ?? Localizer["Category_Uncategorized"];
                            var categoryId = $"expense-cat-{categoryKey}";
                            
                            <div class="category-item-expandable">
                                <div class="category-item-header" @onclick="() => ToggleCategoryInExpenses(categoryId)">
                                    <div>
                                        <span class="category-name">@categoryKey</span>
                                        <span class="expand-icon-small">@(expandedExpenseCategories.Contains(categoryId) ? "▼" : "▶")</span>
                                    </div>
                                    <span class="category-amount">@FormatCurrency(category.Value)</span>
                                </div>
                                
                                @if (expandedExpenseCategories.Contains(categoryId))
                                {
                                    <div class="category-items-detail">
                                        @{
                                            var rawCategoryKey = category.Key ?? "Uncategorized";
                                            var itemsInCategory = currentExpenses.Receipts
                                                .SelectMany(r => r.Items)
                                                .Where(i => (i.Category ?? "Uncategorized") == rawCategoryKey)
                                                .GroupBy(i => i.Name)
                                                .Select(g => new {
                                                    Name = g.Key,
                                                    TotalQty = g.Sum(i => i.Quantity),
                                                    AvgPrice = g.Average(i => i.Price),
                                                    TotalSpent = g.Sum(i => i.Price * i.Quantity),
                                                    Count = g.Count()
                                                })
                                                .OrderByDescending(i => i.TotalSpent);
                                        }
                                        
                                        @foreach (var item in itemsInCategory)
                                        {
                                            <div class="category-detail-row">
                                                <span class="detail-item-name">@item.Name</span>
                                                <span class="detail-item-info">
                                                    @item.Count× | Qty: @item.TotalQty | Avg: @FormatCurrency(item.AvgPrice)
                                                </span>
                                                <span class="detail-item-total">@FormatCurrency(item.TotalSpent)</span>
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        }
                    </div>

                    <h3>@Localizer["Heading_Receipts"] (@currentExpenses.Receipts.Count)</h3>
                    
                    @if (selectedReceiptsForDeletion.Any())
                    {
                        <div class="delete-receipts-bar">
                            <span>@selectedReceiptsForDeletion.Count @Localizer["Label_ReceiptsSelected"]</span>
                            <div>
                                <button class="btn-small btn-secondary" @onclick="ClearReceiptSelection">Clear Selection</button>
                                <button class="btn-small btn-danger" @onclick="ShowDeleteReceiptsConfirmation">@Localizer["Button_DeleteSelected"]</button>
                            </div>
                        </div>
                    }
                    
                    <div class="receipts-list">
                        @foreach (var receipt in currentExpenses.Receipts)
                        {
                            <div class="receipt-item @(selectedReceiptsForDeletion.Contains(receipt) ? "selected" : "")">
                                <div class="receipt-header-with-checkbox">
                                    <input type="checkbox" 
                                           checked="@selectedReceiptsForDeletion.Contains(receipt)"
                                           @onchange="@(e => ToggleReceiptSelection(receipt))"
                                           class="receipt-checkbox"
                                           @onclick:stopPropagation="true" />
                                     <div class="receipt-header-content" @onclick="() => ToggleReceiptExpansion(receipt.Date.ToString() + receipt.Store)">
                                        <div>
                                            <strong>@receipt.Date.ToString("yyyy-MM-dd")</strong>
                                            <small style="margin-left: 10px; color: #666;">@receipt.Store</small>
                                        </div>
                                        <div>
                                            <strong>@FormatCurrency(receipt.Total)</strong>
                                            <span class="expand-icon">@(expandedReceipts.Contains(receipt.Date.ToString() + receipt.Store) ? "▼" : "▶")</span>
                                        </div>
                                    </div>
                                </div>
                                
                                @if (expandedReceipts.Contains(receipt.Date.ToString() + receipt.Store))
                                {
                                    <div class="receipt-items-list">
                                        <div class="items-header">
                                            <span>@Localizer["TableHeader_Item"]</span>
                                            <span>@Localizer["TableHeader_Quantity"]</span>
                                            <span>@Localizer["TableHeader_Price"]</span>
                                            <span>@Localizer["Label_Total"]</span>
                                        </div>
                                        @foreach (var item in receipt.Items)
                                        {
                                            <div class="item-row">
                                                <span class="item-name">
                                                    @item.Name
                                                    @if (!string.IsNullOrEmpty(item.Category))
                                                    {
                                                        <span class="item-category">[@item.Category]</span>
                                                    }
                                                </span>
                                                <span class="item-quantity">@item.Quantity</span>
                                                <span class="item-price">@FormatCurrency(item.Price)</span>
                                                <span class="item-total">@FormatCurrency(item.Price * item.Quantity)</span>
                                            </div>
                                        }
                                        <div class="items-total">
                                            <span>@Localizer["Label_Total"]:</span>
                                            <span>@FormatCurrency(receipt.Total)</span>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    }
    else if (activeTab == "items")
    {
        <div class="tab-content">
            <h2>@Localizer["Heading_ItemsByDate"]</h2>
            
            <div class="date-range-selector">
                <div class="date-input-group">
                    <label>@Localizer["Label_From"]</label>
                    <input type="date" value="@itemsStartDate" @onchange="@(e => itemsStartDate = e.Value?.ToString() ?? "")" class="date-input" />
                </div>
                <div class="date-input-group">
                    <label>@Localizer["Label_To"]</label>
                    <input type="date" value="@itemsEndDate" @onchange="@(e => itemsEndDate = e.Value?.ToString() ?? "")" class="date-input" />
                </div>
                <button class="btn btn-primary" @onclick="LoadItemsByDateRange">@Localizer["Button_Search"]</button>
            </div>

            @if (itemsInDateRange != null && itemsInDateRange.Any())
            {
                <div class="items-summary">
                    <h3>@Localizer["Heading_ItemsByDate"]: @itemsStartDate to @itemsEndDate</h3>
                    <p class="items-count">@Localizer["Label_Total"]: @itemsInDateRange.Count @Localizer["Category_Items"]</p>

                    <div class="items-table">
                        <div class="items-table-header">
                            <span>@Localizer["TableHeader_Item"]</span>
                            <span>@Localizer["TableHeader_Category"]</span>
                            <span>@Localizer["TableHeader_TimesPurchased"]</span>
                            <span>@Localizer["TableHeader_TotalQuantity"]</span>
                            <span>@Localizer["TableHeader_AvgPrice"]</span>
                            <span>@Localizer["TableHeader_TotalSpent"]</span>
                        </div>
                        @foreach (var itemGroup in itemsInDateRange.GroupBy(i => i.Name))
                        {
                            var totalQty = itemGroup.Sum(i => i.Quantity);
                            var avgPrice = itemGroup.Average(i => i.Price);
                            var totalSpent = itemGroup.Sum(i => i.Price * i.Quantity);
                            var category = itemGroup.First().Category ?? Localizer["Category_Uncategorized"];
                            
                            <div class="items-table-row">
                                <span class="item-name-cell">@itemGroup.Key</span>
                                <span class="category-cell">
                                    @if (!string.IsNullOrEmpty(category))
                                    {
                                        <span class="category-tag">@category</span>
                                    }
                                </span>
                                <span class="center-cell">@itemGroup.Count()</span>
                                <span class="center-cell">@totalQty</span>
                                <span class="right-cell">@FormatCurrency(avgPrice)</span>
                                <span class="right-cell total-cell">@FormatCurrency(totalSpent)</span>
                            </div>
                        }
                    </div>

                    <div class="items-grand-total">
                        <span>@Localizer["Label_Total"]:</span>
                        <span>@FormatCurrency(itemsInDateRange.Sum(i => i.Price * i.Quantity))</span>
                    </div>
                </div>
            }
            else if (itemsInDateRange != null)
            {
                <p class="no-data">@Localizer["Message_NoItemsFound"]</p>
            }
        </div>
    }
    else if (activeTab == "categories")
    {
        <div class="tab-content">
            <div class="categories-header-row">
                <h2>@Localizer["Heading_Categories"]</h2>
                <button class="btn-danger-large" @onclick="ShowClearDbConfirmation">@Localizer["Heading_ClearDatabase"]</button>
            </div>
            
            @if (showClearDbConfirmation)
            {
                <div class="confirmation-overlay">
                    <div class="confirmation-dialog-large">
                        <h3>@Localizer["Dialog_ClearDatabase"]</h3>
                        <p>Choose what you want to delete:</p>
                        
                        <div class="clear-options">
                            <div class="clear-option-card">
                                <h4>@Localizer["Button_ClearReceiptsOnly"]</h4>
                                <p>Deletes:</p>
                                <ul>
                                    <li>All receipts (@DataService.GetAllReceipts().Count receipts)</li>
                                    <li>All expense history</li>
                                </ul>
                                <p class="keep-text">✓ Keeps all categories (@DataService.GetAllCategories().Count categories)</p>
                                <button class="btn-warning-confirm" @onclick="ClearReceiptsOnly">@Localizer["Button_YesClearReceipts"]</button>
                            </div>
                            
                            <div class="clear-option-card danger-card">
                                <h4>@Localizer["Button_ClearEverything"]</h4>
                                <p>Deletes:</p>
                                <ul>
                                    <li>All receipts (@DataService.GetAllReceipts().Count receipts)</li>
                                    <li>All categories (@DataService.GetAllCategories().Count categories)</li>
                                    <li>All expense history</li>
                                </ul>
                                <p class="warning-text-small">@Localizer["Message_CannotUndo"]</p>
                                <button class="btn-danger-confirm" @onclick="ClearAllData">@Localizer["Button_YesClearEverything"]</button>
                            </div>
                        </div>
                        
                        <div class="confirmation-actions">
                            <button class="btn-cancel-large" @onclick="CancelClearDb">@Localizer["Button_Cancel"]</button>
                        </div>
                    </div>
                </div>
            }
            
            @if (DataService.GetCategoriesWithItems().Any())
            {
                <div class="categories-management">
                    @foreach (var category in DataService.GetCategoriesWithItems().OrderBy(c => c.Name))
                    {
                        <div class="category-section">
                            <div class="category-header">
                                @if (editingCategory == category.Name)
                                {
                                    <input type="text" @bind="categoryNewName" class="form-input-inline" @onkeyup="@(e => { if (e.Key == "Enter") SaveCategoryRename(); })" />
                                    <button class="btn-small btn-success" @onclick="SaveCategoryRename">✓</button>
                                    <button class="btn-small btn-cancel" @onclick="CancelCategoryEdit">✕</button>
                                }
                                else
                                {
                                    <h3>@category.Name (@category.Items.Count @Localizer["Category_Items"])</h3>
                                    <div class="category-actions">
                                        <button class="btn-small btn-secondary" @onclick="() => StartEditCategory(category.Name)">@Localizer["Button_Rename"]</button>
                                        <button class="btn-small btn-danger" @onclick="() => DeleteCategoryConfirm(category.Name)">@Localizer["Button_Delete"]</button>
                                        <button class="btn-small" @onclick="() => ToggleCategoryExpansion(category.Name)">
                                            @(expandedCategories.Contains(category.Name) ? "▼ Collapse" : "▶ Expand")
                                        </button>
                                    </div>
                                }
                            </div>
                            
                            @if (expandedCategories.Contains(category.Name))
                            {
                                <div class="category-items">
                                    @foreach (var item in category.Items.OrderBy(i => i))
                                    {
                                        <div class="category-item-row">
                                            <span class="item-name-cat">@item</span>
                                            <div class="item-actions">
                                                @if (movingItem == item && movingFromCategory == category.Name)
                                                {
                                                    <select @bind="moveToCategory" class="form-select-inline">
                                                        <option value="">Select category...</option>
                                                        @foreach (var cat in DataService.GetAllCategories().Where(c => !c.Equals(category.Name, StringComparison.OrdinalIgnoreCase)))
                                                        {
                                                            <option value="@cat">@cat</option>
                                                        }
                                                    </select>
                                                    <button class="btn-small btn-success" @onclick="() => ExecuteMove()">@Localizer["Button_Move"]</button>
                                                    <button class="btn-small btn-cancel" @onclick="CancelMove">@Localizer["Button_Cancel"]</button>
                                                }
                                                else
                                                {
                                                    <button class="btn-small btn-secondary" @onclick="() => StartMoveItem(item, category.Name)">@Localizer["Button_Move"]</button>
                                                    <button class="btn-small btn-danger" @onclick="() => RemoveItem(item, category.Name)">@Localizer["Button_Remove"]</button>
                                                }
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    }
                </div>
            }
            else
            {
                <p>@Localizer["Message_NoCategoriesYet"]</p>
            }
        </div>
    }
</div>

<style>
    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    h1 {
        color: #333;
        margin-bottom: 30px;
    }

    .tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        border-bottom: 2px solid #e0e0e0;
    }

    .tabs button {
        padding: 10px 20px;
        border: none;
        background: transparent;
        cursor: pointer;
        font-size: 16px;
        border-bottom: 3px solid transparent;
        transition: all 0.3s;
    }

    .tabs button:hover {
        background: #f5f5f5;
    }

    .tabs button.active {
        border-bottom-color: #007bff;
        color: #007bff;
        font-weight: 600;
    }

    .tab-content {
        padding: 20px 0;
    }

    .categorization-prompt {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        border: 2px solid #007bff;
    }

    .form-input {
        width: 100%;
        padding: 10px;
        margin: 10px 0;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 16px;
    }

    .existing-categories {
        margin: 15px 0;
    }

    .category-btn {
        padding: 8px 16px;
        margin: 5px;
        border: 1px solid #007bff;
        background: white;
        color: #007bff;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s;
    }

    .category-btn:hover {
        background: #007bff;
        color: white;
    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        transition: all 0.3s;
    }

    .btn-primary {
        background: #007bff;
        color: white;
    }

    .btn-primary:hover {
        background: #0056b3;
    }

    .upload-section {
        padding: 40px;
        border: 2px dashed #ddd;
        border-radius: 8px;
        text-align: center;
    }

    .success {
        color: #28a745;
        font-weight: 600;
        margin-top: 10px;
    }

    .error {
        color: #dc3545;
        font-weight: 600;
        margin-top: 10px;
    }

    .period-selector {
        margin-bottom: 20px;
    }

    .period-selector label {
        margin-right: 10px;
        font-weight: 600;
    }

    .period-selector input {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 16px;
    }

    .expenses-summary {
        background: white;
    }

    .total {
        color: #007bff;
        font-size: 2em;
        margin: 20px 0;
    }

    .category-breakdown {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
    }

    .category-item {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid #e0e0e0;
    }

    .category-item:last-child {
        border-bottom: none;
    }

    .category-name {
        font-weight: 600;
    }

    .category-amount {
        color: #007bff;
        font-weight: 600;
    }

    .category-item-expandable {
        border-bottom: 1px solid #e0e0e0;
        margin-bottom: 5px;
    }

    .category-item-expandable:last-child {
        border-bottom: none;
    }

    .category-item-header {
        display: flex;
        justify-content: space-between;
        padding: 12px 10px;
        cursor: pointer;
        user-select: none;
        transition: background 0.2s;
    }

    .category-item-header:hover {
        background: rgba(0, 123, 255, 0.05);
        border-radius: 4px;
    }

    .expand-icon-small {
        margin-left: 10px;
        color: #007bff;
        font-size: 0.85em;
    }

    .category-items-detail {
        padding: 10px 20px 10px 30px;
        background: white;
        border-radius: 4px;
        margin: 5px 0 10px 0;
    }

    .category-detail-row {
        display: grid;
        grid-template-columns: 2fr 2fr 1fr;
        gap: 15px;
        padding: 8px 0;
        border-bottom: 1px solid #f0f0f0;
        align-items: center;
    }

    .category-detail-row:last-child {
        border-bottom: none;
    }

    .detail-item-name {
        font-weight: 500;
        color: #333;
    }

    .detail-item-info {
        font-size: 0.9em;
        color: #666;
    }

    .detail-item-total {
        text-align: right;
        font-weight: 600;
        color: #007bff;
    }


    .receipts-list {
        margin-top: 20px;
    }

    .receipt-item {
        background: #f8f9fa;
        padding: 15px;
        margin: 10px 0;
        border-radius: 8px;
        border-left: 4px solid #007bff;
        transition: all 0.2s;
    }

    .receipt-item.selected {
        background: #e3f2fd;
        border-left-color: #1976d2;
        box-shadow: 0 2px 8px rgba(25, 118, 210, 0.2);
    }

    .receipt-header-with-checkbox {
        display: flex;
        gap: 12px;
        align-items: flex-start;
    }

    .receipt-checkbox {
        margin-top: 3px;
        width: 18px;
        height: 18px;
        cursor: pointer;
        flex-shrink: 0;
    }

    .receipt-header-content {
        flex: 1;
        display: flex;
        justify-content: space-between;
        cursor: pointer;
        user-select: none;
    }

    .receipt-header-content:hover {
        background: rgba(0, 123, 255, 0.05);
        margin: -5px;
        padding: 5px;
        border-radius: 4px;
    }

    .delete-receipts-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #fff3cd;
        border: 2px solid #ffc107;
        border-radius: 8px;
        padding: 12px 20px;
        margin-bottom: 15px;
        font-weight: 600;
    }

    .delete-receipts-bar > div {
        display: flex;
        gap: 10px;
    }

    .delete-receipts-list {
        max-height: 200px;
        overflow-y: auto;
    }

    .delete-receipts-list li {
        padding: 5px 0;
    }

    .expand-icon {
        margin-left: 10px;
        color: #007bff;
        font-size: 0.8em;
    }

    .receipt-details {
        color: #666;
    }

    .receipt-items-list {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 2px solid #dee2e6;
    }

    .items-header {
        display: grid;
        grid-template-columns: 2fr 0.5fr 1fr 1fr;
        gap: 10px;
        padding: 10px;
        background: #e9ecef;
        border-radius: 4px;
        font-weight: 600;
        font-size: 0.9em;
    }

    .item-row {
        display: grid;
        grid-template-columns: 2fr 0.5fr 1fr 1fr;
        gap: 10px;
        padding: 10px;
        border-bottom: 1px solid #e9ecef;
        align-items: center;
    }

    .item-row:last-of-type {
        border-bottom: 2px solid #dee2e6;
    }

    .item-name {
        font-weight: 500;
    }

    .item-category {
        font-size: 0.85em;
        color: #007bff;
        font-weight: 400;
        margin-left: 8px;
    }

    .item-quantity {
        text-align: center;
    }

    .item-price, .item-total {
        text-align: right;
        font-weight: 500;
    }

    .items-total {
        display: flex;
        justify-content: space-between;
        padding: 10px;
        font-weight: 700;
        font-size: 1.1em;
        color: #007bff;
        margin-top: 5px;
    }

    .categories-list {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }

    .category-badge {
        padding: 8px 16px;
        background: #007bff;
        color: white;
        border-radius: 20px;
        font-weight: 600;
    }

    .categories-management {
        margin-top: 20px;
    }

    .category-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        border-left: 4px solid #007bff;
    }

    .category-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .category-header h3 {
        margin: 0;
        color: #333;
    }

    .category-actions {
        display: flex;
        gap: 10px;
    }

    .btn-small {
        padding: 6px 12px;
        border: 1px solid #ddd;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s;
    }

    .btn-small:hover {
        background: #f8f9fa;
    }

    .btn-secondary {
        border-color: #6c757d;
        color: #6c757d;
    }

    .btn-secondary:hover {
        background: #6c757d;
        color: white;
    }

    .btn-danger {
        border-color: #dc3545;
        color: #dc3545;
    }

    .btn-danger:hover {
        background: #dc3545;
        color: white;
    }

    .btn-success {
        border-color: #28a745;
        color: #28a745;
    }

    .btn-success:hover {
        background: #28a745;
        color: white;
    }

    .btn-cancel {
        border-color: #6c757d;
        background: #6c757d;
        color: white;
    }

    .btn-cancel:hover {
        background: #5a6268;
    }

    .form-input-inline {
        padding: 6px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 16px;
        margin-right: 10px;
        width: 300px;
    }

    .form-select-inline {
        padding: 6px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        margin-right: 10px;
        min-width: 200px;
    }

    .category-items {
        margin-top: 10px;
    }

    .category-item-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        background: white;
        border-radius: 4px;
        margin-bottom: 8px;
        border: 1px solid #e9ecef;
    }

    .category-item-row:hover {
        border-color: #007bff;
        box-shadow: 0 2px 4px rgba(0,123,255,0.1);
    }

    .item-name-cat {
        font-weight: 500;
        color: #333;
    }

    .item-actions {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .categories-header-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .categories-header-row h2 {
        margin: 0;
    }

    .btn-danger-large {
        padding: 10px 20px;
        border: 2px solid #dc3545;
        background: white;
        color: #dc3545;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        transition: all 0.3s;
    }

    .btn-danger-large:hover {
        background: #dc3545;
        color: white;
    }

    .confirmation-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .confirmation-dialog {
        background: white;
        padding: 30px;
        border-radius: 12px;
        max-width: 500px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }

    .confirmation-dialog-large {
        background: white;
        padding: 30px;
        border-radius: 12px;
        max-width: 800px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }

    .confirmation-dialog-large h3 {
        color: #333;
        margin-top: 0;
        font-size: 24px;
        text-align: center;
    }

    .clear-options {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin: 20px 0;
    }

    .clear-option-card {
        background: #f8f9fa;
        border: 2px solid #007bff;
        border-radius: 8px;
        padding: 20px;
        text-align: left;
    }

    .clear-option-card.danger-card {
        border-color: #dc3545;
        background: #fff5f5;
    }

    .clear-option-card h4 {
        color: #007bff;
        margin-top: 0;
        font-size: 18px;
    }

    .clear-option-card.danger-card h4 {
        color: #dc3545;
    }

    .clear-option-card p {
        margin: 10px 0;
        font-size: 14px;
    }

    .clear-option-card ul {
        text-align: left;
        margin: 10px 0;
        padding-left: 20px;
        font-size: 14px;
    }

    .clear-option-card li {
        margin: 5px 0;
    }

    .keep-text {
        color: #28a745;
        font-weight: 600;
        margin-top: 15px;
    }

    .warning-text-small {
        color: #dc3545;
        font-weight: 600;
        margin-top: 15px;
    }

    .btn-warning-confirm {
        width: 100%;
        padding: 12px 24px;
        border: none;
        background: #ffc107;
        color: #333;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        transition: all 0.3s;
        margin-top: 15px;
    }

    .btn-warning-confirm:hover {
        background: #e0a800;
        transform: scale(1.02);
    }

    .confirmation-dialog h3 {
        color: #dc3545;
        margin-top: 0;
        font-size: 24px;
    }

    .confirmation-dialog ul {
        text-align: left;
        margin: 20px 0;
        padding-left: 20px;
    }

    .confirmation-dialog li {
        margin: 8px 0;
        font-size: 16px;
    }

    .warning-text {
        color: #dc3545;
        font-weight: 700;
        font-size: 18px;
        margin: 20px 0;
    }

    .confirmation-actions {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 25px;
    }

    .btn-danger-confirm {
        padding: 12px 24px;
        border: none;
        background: #dc3545;
        color: white;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        transition: all 0.3s;
    }

    .btn-danger-confirm:hover {
        background: #c82333;
        transform: scale(1.05);
    }

    .btn-cancel-large {
        padding: 12px 24px;
        border: 2px solid #6c757d;
        background: white;
        color: #6c757d;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        transition: all 0.3s;
    }

    .btn-cancel-large:hover {
        background: #6c757d;
        color: white;
    }

    .date-range-selector {
        display: flex;
        gap: 20px;
        align-items: flex-end;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .date-input-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .date-input-group label {
        font-weight: 600;
        font-size: 14px;
        color: #333;
    }

    .date-input {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 16px;
        min-width: 180px;
    }

    .items-summary {
        margin-top: 20px;
    }

    .items-count {
        color: #666;
        font-size: 16px;
        margin: 10px 0 20px 0;
    }

    .items-table {
        background: white;
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid #e9ecef;
    }

    .items-table-header {
        display: grid;
        grid-template-columns: 2fr 1.5fr 1fr 1fr 1fr 1fr;
        gap: 15px;
        padding: 15px;
        background: #007bff;
        color: white;
        font-weight: 600;
        font-size: 14px;
    }

    .items-table-row {
        display: grid;
        grid-template-columns: 2fr 1.5fr 1fr 1fr 1fr 1fr;
        gap: 15px;
        padding: 15px;
        border-bottom: 1px solid #e9ecef;
        align-items: center;
        transition: background 0.2s;
    }

    .items-table-row:hover {
        background: #f8f9fa;
    }

    .items-table-row:last-child {
        border-bottom: none;
    }

    .item-name-cell {
        font-weight: 500;
        color: #333;
    }

    .category-cell {
        display: flex;
        align-items: center;
    }

    .category-tag {
        padding: 4px 12px;
        background: #007bff;
        color: white;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }

    .center-cell {
        text-align: center;
    }

    .right-cell {
        text-align: right;
        font-weight: 500;
    }

    .total-cell {
        color: #007bff;
        font-weight: 600;
    }

    .items-grand-total {
        display: flex;
        justify-content: space-between;
        padding: 20px;
        background: #007bff;
        color: white;
        font-size: 20px;
        font-weight: 700;
        border-radius: 8px;
        margin-top: 20px;
    }

    .no-data {
        text-align: center;
        padding: 40px;
        color: #666;
        font-size: 18px;
    }

</style>

@code {
    private string activeTab = "add";
    private string uploadMessage = "";
    private bool uploadSuccess = false;
    private List<ReceiptItem> pendingCategorizationItems = new();
    private string newCategory = "";
    private Receipt? currentReceipt;
    private ExpensePeriod? currentExpenses;
    private string selectedPeriod = DateTime.Now.ToString("yyyy-MM");
    private HashSet<string> expandedReceipts = new();
    private HashSet<string> expandedCategories = new();
    private HashSet<string> expandedExpenseCategories = new();
    private string? editingCategory = null;
    private string categoryNewName = "";
    private string? movingItem = null;
    private string? movingFromCategory = null;
    private string moveToCategory = "";
    private bool showClearDbConfirmation = false;
    private bool showDeleteReceiptsConfirmation = false;
    private List<Receipt> selectedReceiptsForDeletion = new();
    private string itemsStartDate = DateTime.Now.AddMonths(-1).ToString("yyyy-MM-dd");
    private string itemsEndDate = DateTime.Now.ToString("yyyy-MM-dd");
    private List<ReceiptItem>? itemsInDateRange = null;

    protected override void OnInitialized()
    {
        LoadExpenses();
    }
    
    private string FormatCurrency(decimal amount)
    {
        // Always format as SEK with Swedish number format (comma as decimal separator)
        return $"{amount:N2} kr";
    }

    private void ToggleReceiptSelection(Receipt receipt)
    {
        if (selectedReceiptsForDeletion.Contains(receipt))
        {
            selectedReceiptsForDeletion.Remove(receipt);
        }
        else
        {
            selectedReceiptsForDeletion.Add(receipt);
        }
    }

    private void ClearReceiptSelection()
    {
        selectedReceiptsForDeletion.Clear();
    }

    private void ShowDeleteReceiptsConfirmation()
    {
        showDeleteReceiptsConfirmation = true;
    }

    private void CancelDeleteReceipts()
    {
        showDeleteReceiptsConfirmation = false;
    }

    private void DeleteSelectedReceipts()
    {
        DataService.DeleteReceipts(selectedReceiptsForDeletion);
        showDeleteReceiptsConfirmation = false;
        selectedReceiptsForDeletion.Clear();
        LoadExpenses();
        uploadMessage = Localizer["Message_ReceiptsDeleted"];
        uploadSuccess = true;
    }

    private void LoadItemsByDateRange()
    {
        if (DateTime.TryParse(itemsStartDate, out var start) && DateTime.TryParse(itemsEndDate, out var end))
        {
            itemsInDateRange = DataService.GetItemsByDateRange(start, end.AddDays(1).AddSeconds(-1));
        }
    }

    private void ShowClearDbConfirmation()
    {
        showClearDbConfirmation = true;
    }

    private void CancelClearDb()
    {
        showClearDbConfirmation = false;
    }

    private void ClearAllData()
    {
        DataService.ClearAllData();
        showClearDbConfirmation = false;
        expandedReceipts.Clear();
        expandedCategories.Clear();
        expandedExpenseCategories.Clear();
        LoadExpenses();
        uploadMessage = Localizer["Message_DatabaseCleared"];
        uploadSuccess = true;
    }

    private void ClearReceiptsOnly()
    {
        DataService.ClearReceiptsOnly();
        showClearDbConfirmation = false;
        expandedReceipts.Clear();
        expandedExpenseCategories.Clear();
        LoadExpenses();
        uploadMessage = Localizer["Message_ReceiptsCleared"];
        uploadSuccess = true;
    }

    private void ToggleReceiptExpansion(string receiptId)
    {
        if (expandedReceipts.Contains(receiptId))
        {
            expandedReceipts.Remove(receiptId);
        }
        else
        {
            expandedReceipts.Add(receiptId);
        }
    }

    private void ToggleCategoryExpansion(string categoryName)
    {
        if (expandedCategories.Contains(categoryName))
        {
            expandedCategories.Remove(categoryName);
        }
        else
        {
            expandedCategories.Add(categoryName);
        }
    }

    private void ToggleCategoryInExpenses(string categoryId)
    {
        if (expandedExpenseCategories.Contains(categoryId))
        {
            expandedExpenseCategories.Remove(categoryId);
        }
        else
        {
            expandedExpenseCategories.Add(categoryId);
        }
    }

    private void StartEditCategory(string categoryName)
    {
        editingCategory = categoryName;
        categoryNewName = categoryName;
    }

    private void SaveCategoryRename()
    {
        if (!string.IsNullOrWhiteSpace(categoryNewName) && editingCategory != null)
        {
            DataService.RenameCategory(editingCategory, categoryNewName);
            editingCategory = null;
            categoryNewName = "";
            LoadExpenses();
        }
    }

    private void CancelCategoryEdit()
    {
        editingCategory = null;
        categoryNewName = "";
    }

    private void DeleteCategoryConfirm(string categoryName)
    {
        DataService.DeleteCategory(categoryName);
        expandedCategories.Remove(categoryName);
        LoadExpenses();
    }

    private void StartMoveItem(string itemName, string fromCategory)
    {
        movingItem = itemName;
        movingFromCategory = fromCategory;
        moveToCategory = "";
    }

    private void ExecuteMove()
    {
        if (!string.IsNullOrWhiteSpace(moveToCategory) && movingItem != null && movingFromCategory != null)
        {
            DataService.MoveItemToCategory(movingItem, movingFromCategory, moveToCategory);
            CancelMove();
            LoadExpenses();
        }
    }

    private void CancelMove()
    {
        movingItem = null;
        movingFromCategory = null;
        moveToCategory = "";
    }

    private void RemoveItem(string itemName, string categoryName)
    {
        DataService.RemoveItemFromCategory(itemName, categoryName);
        LoadExpenses();
    }

    private void LoadExpenses()
    {
        if (DateTime.TryParse(selectedPeriod + "-01", out var date))
        {
            var month = date.Day < 25 ? date.Month - 1 : date.Month;
            var year = month < 1 ? date.Year - 1 : date.Year;
            month = month < 1 ? 12 : month;
            
            currentExpenses = DataService.GetExpensesByPeriod(year, month);
        }
        else
        {
            currentExpenses = DataService.GetCurrentPeriod();
        }
    }

    private void OnPeriodChanged(ChangeEventArgs e)
    {
        selectedPeriod = e.Value?.ToString() ?? DateTime.Now.ToString("yyyy-MM");
        LoadExpenses();
    }

    private async Task HandleFileUpload(InputFileChangeEventArgs e)
    {
        try
        {
            uploadMessage = "Processing PDF...";
            uploadSuccess = false;
            StateHasChanged(); // Force UI update to show processing message
            
            var file = e.File;
            using var stream = file.OpenReadStream(maxAllowedSize: 10485760); // 10MB limit

            var parser = new ReceiptParserService(DataService);
            currentReceipt = await parser.ParsePdfReceiptAsync(stream);

            if (currentReceipt.Items.Count == 0)
            {
                uploadMessage = "Error: No items found in receipt. Check pdf_debug.log in project folder for details.";
                uploadSuccess = false;
                return;
            }

            // Check for duplicate receipt
            if (DataService.IsDuplicateReceipt(currentReceipt))
            {
                uploadMessage = Localizer["Message_DuplicateDetected"];
                uploadSuccess = false;
                currentReceipt = null;
                return;
            }

            pendingCategorizationItems = currentReceipt.Items
                .Where(i => string.IsNullOrEmpty(i.Category))
                .ToList();

            if (!pendingCategorizationItems.Any())
            {
                DataService.AddReceipt(currentReceipt);
                uploadMessage = string.Format(Localizer["Message_ReceiptAdded"], currentReceipt.Items.Count, FormatCurrency(currentReceipt.Total));
                uploadSuccess = true;
                currentReceipt = null;
                LoadExpenses();
            }
            else
            {
                uploadMessage = $"Parsed {currentReceipt.Items.Count} items ({FormatCurrency(currentReceipt.Total)}). Please categorize {pendingCategorizationItems.Count} new items.";
            }
        }
        catch (Exception ex)
        {
            uploadMessage = string.Format(Localizer["Message_ErrorProcessing"], ex.Message);
            uploadSuccess = false;
        }
    }

    private void AssignCategory(string category)
    {
        newCategory = category;
    }

    private void SaveCategory()
    {
        if (string.IsNullOrWhiteSpace(newCategory) || !pendingCategorizationItems.Any())
            return;

        var item = pendingCategorizationItems[0];
        item.Category = newCategory;
        DataService.AddItemToCategory(item.Name, newCategory);
        
        pendingCategorizationItems.RemoveAt(0);
        newCategory = "";

        if (!pendingCategorizationItems.Any() && currentReceipt != null)
        {
            DataService.AddReceipt(currentReceipt);
            uploadMessage = string.Format(Localizer["Message_ReceiptAdded"], currentReceipt.Items.Count, FormatCurrency(currentReceipt.Total));
            uploadSuccess = true;
            currentReceipt = null;
            LoadExpenses();
        }
    }
}
